#!/bin/bash

set -o errexit

cd "${BASH_SOURCE[0]%%/*}"

# http://hg.openjdk.java.net/jdk9/jdk9/hotspot/tags
readonly jdk_hsdis_rev='jdk-9+181'
readonly hotspot="hotspot-$jdk_hsdis_rev"

readonly binutils_version='2.23.2'
readonly binutils="binutils-$binutils_version"

# Arguments:
# 1  in: The absolute path to the hsdis library's parent directory
check_load_lib()
{
    local -r _hsdis_lib_dir="$1"

    [[ T.class -nt T.java ]] || javac T.java

    set -x
    LD_LIBRARY_PATH="$_hsdis_lib_dir" \
        java -XX:+UnlockDiagnosticVMOptions \
        -XX:+PrintAssembly \
        T | grep 'hsdis'
}

fix_binutils()
{
    local -r _binutils="$1"

    # Work around build bug 15345 in binutils, per hsdis README.
    # The timestamp has to be after the files generated by make.
    touch --date='2099-12-31' "${_binutils}/bfd/doc/bfd.info"

    # The hsdis Makefile does not allow us to pass along configure arguments to
    # binutils so we can't easily disable warnings the proper way. Patch the
    # configure files instead.
    patch --forward --strip=1 < "$binutils.patch"
}

main()
{
    if ! [[ -d "$hotspot" ]]
    then
        readonly hsdis_archive="$jdk_hsdis_rev.tar.bz2"
        [[ -f $hsdis_archive ]] ||
            wget http://hg.openjdk.java.net/jdk9/jdk9/hotspot/archive/$hsdis_archive
        tar xf "$hsdis_archive"
    fi

    if ! [[ -d "$binutils" ]]
    then
        readonly binutils_archive="$binutils.tar.gz"
        [[ -f "$binutils_archive" ]] ||
            wget https://ftp.heanet.ie/mirrors/gnu/binutils/$binutils_archive
        tar xf "$binutils_archive"

        fix_binutils "$binutils"
    fi

    readonly hsdis_path="$PWD/$hotspot/src/share/tools/hsdis"
    readonly hsdis_lib_dir="$hsdis_path/build/linux-amd64"

    make --directory="$hsdis_path" "BINUTILS=$PWD/$binutils" ARCH=amd64

    readonly result="$(check_load_lib "$hsdis_lib_dir")"
    printf '%s\n' "$result"
    [[ $result =~ ^Loaded ]] || exit 1
}

main
